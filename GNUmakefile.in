### @configure_input@

AR = ar
CC = @CC@
CXX = @CXX@

CXXFLAGS = -W -Wall @CXXFLAGS@

DEPSDIR := .deps
DEPCFLAGS = -MD -MF $(DEPSDIR)/$*.d -MP
top_srcdir = @top_srcdir@
builddir = .

OBJDIR = obj

TAMER_COMMIT = 798736ef67d0b6c92567ddeff1a72f20129ff67e

INCLUDES = -include config.h -I$(top_srcdir)/src -I$(top_srcdir)/lib \
           -I$(top_srcdir)/app -I$(top_srcdir)/tamer -I$(OBJDIR) -I/opt/local/include
LIBS = `$(TAMER) -l` @BOOST_LIBS@ @MALLOC_LIBS@ @POSTGRES_LIBS@ @MEMCACHED_LIB@ @DB_CXX_LIB@ @PQXX_LIB@

CXXFLAGS += $(INCLUDES) -fno-omit-frame-pointer
LDFLAGS += -L/usr/local/lib -L/opt/local/lib

@DEFAULT_MALLOC_ASSIGNMENT@
ifeq ($(shell uname), Darwin)
  # turn off some warnings from clang regarding libev sources - very annoying
  CXXFLAGS += -Wno-mismatched-tags -Wno-ambiguous-member-template
ifndef DEFAULT_MALLOC
  CXXFLAGS += -fno-builtin
endif
else
ifndef DEFAULT_MALLOC
  CXXFLAGS += -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free
endif
endif

ifdef ITRACE
  CXXFLAGS += -DIVAL_TRACE
endif

CXXCOMPILE = $(CXX) $(DEFS) $(CPPFLAGS) $(CXXFLAGS)
CXXLINK = $(CXX) $(CXXFLAGS)

TAMER = tamer/compiler/tamer
TAMERFLAGS = @TAMERFLAGS@
LIBTAMER = tamer/tamer/.libs/libtamer.a


all:    $(OBJDIR)/pqserver $(OBJDIR)/pqinfo 

$(OBJDIR)/%.o: $(top_srcdir)/lib/%.cc config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp
	$(CXXCOMPILE) $(DEPCFLAGS) -c -o $@ $<

$(OBJDIR)/%.o: $(top_srcdir)/lib/%.c config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp
	$(CXXCOMPILE) $(DEPCFLAGS) -c -o $@ $<

$(OBJDIR)/%.o: $(top_srcdir)/app/%.cc config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp
	$(CXXCOMPILE) $(DEPCFLAGS) -c -o $@ $<
        
$(OBJDIR)/%.cc: $(top_srcdir)/app/%.tcc config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp $(TAMER)
	$(TAMER) $(TAMERFLAGS) -F .deps/$*.cc.d -o $@ $<

$(OBJDIR)/%.hh: $(top_srcdir)/app/%.thh config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp $(TAMER)
	$(TAMER) $(TAMERFLAGS) -F .deps/$*.hh.d -o $@ $<

$(OBJDIR)/%.o: $(top_srcdir)/src/%.cc config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp
	$(CXXCOMPILE) $(DEPCFLAGS) -c -o $@ $<

$(OBJDIR)/%.o: $(OBJDIR)/%.cc config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp
	$(CXXCOMPILE) $(DEPCFLAGS) -c -o $@ $<

$(OBJDIR)/%.cc: $(top_srcdir)/src/%.tcc config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp $(TAMER)
	$(TAMER) $(TAMERFLAGS) -F .deps/$*.cc.d -o $@ $<

$(OBJDIR)/%.hh: $(top_srcdir)/src/%.thh config.h $(OBJDIR)/stamp $(DEPSDIR)/stamp $(TAMER)
	$(TAMER) $(TAMERFLAGS) -F .deps/$*.hh.d -o $@ $<


# make sure tamed versions get built first
$(OBJDIR)/mpfd.cc: $(top_srcdir)/src/mpfd.tcc
$(OBJDIR)/mpfd.hh: $(top_srcdir)/src/mpfd.thh
$(OBJDIR)/pqserver.cc: $(top_srcdir)/src/pqserver.tcc
$(OBJDIR)/pqserver.hh: $(top_srcdir)/src/pqserver.thh
$(OBJDIR)/pqpersistent.cc: $(top_srcdir)/src/pqpersistent.tcc
$(OBJDIR)/pqpersistent.hh: $(top_srcdir)/src/pqpersistent.thh
$(OBJDIR)/pqclient.cc: $(top_srcdir)/src/pqclient.tcc
$(OBJDIR)/pqclient.hh: $(top_srcdir)/src/pqclient.thh
$(OBJDIR)/pqremoteclient.cc: $(top_srcdir)/src/pqremoteclient.tcc
$(OBJDIR)/pqremoteclient.hh: $(top_srcdir)/src/pqremoteclient.thh
$(OBJDIR)/pqmulticlient.cc: $(top_srcdir)/src/pqmulticlient.tcc
$(OBJDIR)/pqmulticlient.hh: $(top_srcdir)/src/pqmulticlient.thh
$(OBJDIR)/pqinterconnect.cc: $(top_srcdir)/src/pqinterconnect.tcc
$(OBJDIR)/pqinterconnect.hh: $(top_srcdir)/src/pqinterconnect.thh
$(OBJDIR)/pqdbpool.cc: $(top_srcdir)/src/pqdbpool.tcc
$(OBJDIR)/pqdbpool.hh: $(top_srcdir)/src/pqdbpool.thh
$(OBJDIR)/pqunit2.cc: $(top_srcdir)/src/pqunit2.tcc
$(OBJDIR)/pqhackernews.cc: $(top_srcdir)/app/pqhackernews.tcc
$(OBJDIR)/pqhackernews.hh: $(top_srcdir)/app/pqhackernews.thh
$(OBJDIR)/pqrwmicro.cc: $(top_srcdir)/app/pqrwmicro.tcc
$(OBJDIR)/pqrwmicro.hh: $(top_srcdir)/app/pqrwmicro.thh
$(OBJDIR)/pqtwitter.cc: $(top_srcdir)/app/pqtwitter.tcc
$(OBJDIR)/pqtwitter.hh: $(top_srcdir)/app/pqtwitter.thh
$(OBJDIR)/pqtwitternew.cc: $(top_srcdir)/app/pqtwitternew.tcc
$(OBJDIR)/pqtwitternew.hh: $(top_srcdir)/app/pqtwitternew.thh
$(OBJDIR)/pqanalytics.cc: $(top_srcdir)/app/pqanalytics.tcc
$(OBJDIR)/pqanalytics.hh: $(top_srcdir)/app/pqanalytics.thh
$(OBJDIR)/hnshim.hh: $(top_srcdir)/app/hnshim.thh
$(OBJDIR)/hashclient.cc: $(top_srcdir)/app/hashclient.tcc
$(OBJDIR)/hashclient.hh: $(top_srcdir)/app/hashclient.thh
$(OBJDIR)/redisfd.hh: $(top_srcdir)/app/redisfd.thh
$(OBJDIR)/redisfd.cc: $(top_srcdir)/app/redisfd.tcc
$(OBJDIR)/pqinfo.cc: $(top_srcdir)/app/pqinfo.tcc


$(OBJDIR)/pqserver.o: $(OBJDIR)/pqserver.hh $(OBJDIR)/pqtwitter.hh $(OBJDIR)/pqhackernews.hh $(OBJDIR)/pqtwitternew.hh $(OBJDIR)/pqanalytics.hh $(OBJDIR)/pqrwmicro.hh $(OBJDIR)/pqclient.hh $(OBJDIR)/pqinterconnect.hh $(OBJDIR)/hnshim.hh $(OBJDIR)/hashclient.hh $(OBJDIR)/redisfd.hh
$(OBJDIR)/pqserver.hh: $(OBJDIR)/pqpersistent.hh
$(OBJDIR)/pqserverloop.o: $(OBJDIR)/pqinterconnect.hh
$(OBJDIR)/pqsource.o: $(OBJDIR)/pqinterconnect.hh
$(OBJDIR)/pqsink.o: $(OBJDIR)/pqserver.hh
$(OBJDIR)/mpfd.o: $(OBJDIR)/mpfd.cc $(OBJDIR)/mpfd.hh
$(OBJDIR)/pqserverloop.o: $(OBJDIR)/mpfd.hh
$(OBJDIR)/pqjoin.o: $(OBJDIR)/pqserver.hh
$(OBJDIR)/pqinterconnect.o: $(OBJDIR)/pqinterconnect.hh
$(OBJDIR)/pqinterconnect.hh: $(OBJDIR)/pqremoteclient.hh
$(OBJDIR)/pqmulticlient.o: $(OBJDIR)/pqmulticlient.hh
$(OBJDIR)/pqmulticlient.hh: $(OBJDIR)/pqremoteclient.hh $(OBJDIR)/pqdbpool.hh
$(OBJDIR)/pqremoteclient.hh: $(OBJDIR)/mpfd.hh
$(OBJDIR)/pqremoteclient.o: $(OBJDIR)/pqremoteclient.hh
$(OBJDIR)/pqinfo.o: $(OBJDIR)/pqinfo.cc $(OBJDIR)/pqremoteclient.hh
$(OBJDIR)/pqtwitter.o: $(OBJDIR)/pqtwitter.cc $(OBJDIR)/pqtwitter.hh $(OBJDIR)/pqclient.hh $(OBJDIR)/pqmulticlient.hh $(OBJDIR)/pqremoteclient.hh $(OBJDIR)/mpfd.hh
$(OBJDIR)/pqtwitternew.o: $(OBJDIR)/pqtwitternew.cc $(OBJDIR)/pqtwitternew.hh $(OBJDIR)/pqclient.hh $(OBJDIR)/pqmulticlient.hh $(OBJDIR)/mpfd.hh
$(OBJDIR)/pqanalytics.o: $(OBJDIR)/pqanalytics.cc $(OBJDIR)/pqanalytics.hh $(OBJDIR)/pqclient.hh $(OBJDIR)/pqremoteclient.hh $(OBJDIR)/mpfd.hh
$(OBJDIR)/pqhackernews.o: $(OBJDIR)/pqhackernews.hh $(OBJDIR)/pqclient.hh $(OBJDIR)/pqremoteclient.hh $(OBJDIR)/mpfd.hh
$(OBJDIR)/hashtimer.o: $(OBJDIR)/pqserver.hh

COMMON_OBJS = \
	$(OBJDIR)/str.o \
	$(OBJDIR)/straccum.o \
	$(OBJDIR)/string.o \
	$(OBJDIR)/error.o \
	$(OBJDIR)/json.o \
	$(OBJDIR)/msgpack.o \
	$(OBJDIR)/compiler.o \
	$(OBJDIR)/encoding.o \
	$(OBJDIR)/hashallocator.o \
	$(OBJDIR)/sp_key.o \
	$(OBJDIR)/partitioner.o \
	$(OBJDIR)/hosts.o \
	$(OBJDIR)/clp.o

PQSERVER_OBJS = $(COMMON_OBJS) \
	$(OBJDIR)/pqbase.o \
	$(OBJDIR)/pqjoin.o \
	$(OBJDIR)/pqsource.o \
	$(OBJDIR)/pqsink.o \
	$(OBJDIR)/pqserver.o \
	$(OBJDIR)/pqserverloop.o \
	$(OBJDIR)/mpfd.o \
	$(OBJDIR)/pqpersistent.o \
	$(OBJDIR)/pqpartition.o \
        $(OBJDIR)/pqmemory.o \
        $(OBJDIR)/pqclient.o \
        $(OBJDIR)/pqmulticlient.o \
        $(OBJDIR)/pqremoteclient.o \
        $(OBJDIR)/pqinterconnect.o \
        $(OBJDIR)/pqunit.o \
        $(OBJDIR)/pqunit2.o \
        $(OBJDIR)/pqtwitter.o \
        $(OBJDIR)/pqtwitternew.o \
        $(OBJDIR)/pqhackernews.o \
        $(OBJDIR)/pqanalytics.o \
        $(OBJDIR)/pqfacebook.o \
	$(OBJDIR)/pqdbpool.o \
	$(OBJDIR)/redisclient.o \
	$(OBJDIR)/redisfd.o \
	$(OBJDIR)/hashclient.o \
	$(OBJDIR)/pqrwmicro.o 

PQMAIN_OBJS = $(PQSERVER_OBJS) \
	$(OBJDIR)/pqmain.o

PQINFO_OBJS = $(COMMON_OBJS) \
	$(OBJDIR)/pqremoteclient.o \
	$(OBJDIR)/mpfd.o \
	$(OBJDIR)/pqinfo.o

HASHTIMER_OBJS = $(PQSERVER_OBJS) \
	$(OBJDIR)/hashtimer.o

$(OBJDIR)/pqserver: $(PQMAIN_OBJS) $(LIBTAMER)
	$(CXXLINK) -o $@ $^ $(LDFLAGS) $(LIBS)

$(OBJDIR)/pqinfo: $(PQINFO_OBJS) $(LIBTAMER)
	$(CXXLINK) -o $@ $^ $(LDFLAGS) $(LIBS)

$(OBJDIR)/rbtest: $(OBJDIR)/rbtest.o $(OBJDIR)/str.o $(OBJDIR)/straccum.o $(OBJDIR)/string.o
	$(CXXLINK) -o $@ $^ $(LDFLAGS) $(LIBS)

$(OBJDIR)/jsontest: $(COMMON_OBJS) $(OBJDIR)/jsontest.o
	$(CXXLINK) -o $@ $^ $(LDFLAGS) $(LIBS)

$(OBJDIR)/msgpacktest: $(COMMON_OBJS) $(OBJDIR)/msgpacktest.o
	$(CXXLINK) -o $@ $^ $(LDFLAGS) $(LIBS)

$(OBJDIR)/hashtimer: $(HASHTIMER_OBJS) $(LIBTAMER)
	$(CXXLINK) -o $@ $^ $(LDFLAGS) $(LIBS)

tamer/compiler/tamer $(LIBTAMER): tamer-update

tamer-update:
	@cd ./`git rev-parse --show-cdup` && cur=`git submodule status tamer | head -c 41 | tail -c +2` && if test "$$cur" != $(TAMER_COMMIT) && test -z `cd tamer; git rev-list -n1 $(TAMER_COMMIT)..HEAD 2>/dev/null`; then (echo Updating tamer... 1>&2; cd tamer; git checkout -f master >/dev/null; git pull; cd ..; git submodule update tamer); fi
	cd tamer && $(MAKE) --no-print-directory compiler tamer

$(OBJDIR)/stamp $(DEPSDIR)/stamp:
	mkdir -p $(dir $@)
	touch $@

config.h: stamp-h

GNUmakefile: GNUmakefile.in config.status
	CONFIG_FILES=$@ CONFIG_HEADERS= $(SHELL) ./config.status

$(top_srcdir)/configure $(top_srcdir)/config.h.in: $(top_srcdir)/configure.ac
	cd $(top_srcdir) && autoreconf -i && touch config.h.in

config.status: $(top_srcdir)/configure
	$(top_srcdir)/configure @ac_configure_args@

stamp-h: $(top_srcdir)/config.h.in config.status
	CONFIG_FILES= $(SHELL) ./config.status
	echo > stamp-h

clean:
	rm -rf $(OBJDIR) $(DEPSDIR) $(GENDIR)

allclean: clean
	cd tamer && $(MAKE) clean

distclean: clean
	cd tamer && $(MAKE) distclean
	rm -rf config.* configure autom4te.* stamp-h Makefile

DEPFILES := $(wildcard $(DEPSDIR)/*.d)
ifneq ($(DEPFILES),)
include $(DEPFILES)
endif

always:
	@:

.PHONY: all clean distclean always tamer-update
.PRECIOUS: $(PROTOGENDIR)/%.pb.cc $(PROTOGENDIR)/%.pb.h \
	$(PROTOGENDIR)/%.px.cc $(PROTOGENDIR)/%.px.hh \
	$(OBJ)/%.cc $(OBJ)/%.hh
